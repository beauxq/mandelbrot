(()=>{"use strict";function t(t,s,i,e){return[i*i-e*e+t,i*e*2+s]}function s(s,i,e=512){let h=0,o=0,n=0,a=0;for(;a<=4&&n<e;)[h,o]=t(s,i,h,o),a=h*h+o*o,++n;return n+1/Math.max(a-4,1)}const i=Math.pow(2,1/4),e=1344,h=-77;let o;window.onload=()=>{!function(){for(let t=0;t<32;++t){const i=t/32+1e-6,e=0;console.log(i,s(i,e))}}();const t=window.innerWidth,n=window.innerHeight;o=new class{constructor(t,s){this.canvas=document.getElementById("c"),this.canvas.width=t,this.canvas.height=s,this.context=this.canvas.getContext("2d"),this.context.fillStyle="black",this.context.fillRect(0,0,t,s),this.pixelOrderer=new class{constructor(t,s,i){this.codeToColor=i,this.codeRange=s,this.reset(t)}get rgba(){return this._rgba}reset(t){this.width=t.canvas.width,this.height=t.canvas.height,this._rgba=t.getImageData(0,0,this.width,this.height),this.horizontalSquareCount=Math.ceil(this.width/8),this.verticalSquareCount=Math.ceil(this.height/8);const s=this.horizontalSquareCount*this.verticalSquareCount;this.levelBegin=(1<<Math.floor(Math.log2(s)))-1,this.root=this.nextIndex=this.levelBegin,this.nextIncrement=this.nextIndex+1<<1,this.squareQueueIndex=0,this.currentQueue=-1;const i=Math.ceil((this.codeRange-1)/512);this.queues=[];for(let t=i;t>0;--t)this.queues.push([]);this.queueLowerLimits=[];for(let t=1;t<i;++t)this.queueLowerLimits.push(512*t);this.queueLowerLimits.push(this.codeRange),console.log(this.queueLowerLimits)}colorThisPixel(t,s,i){const e=4*(s*this.width+t);let[h,o,n]=this.codeToColor(i);this._rgba.data[e]=h,this._rgba.data[e+1]=o,this._rgba.data[e+2]=n,this._rgba.data[e+3]=255}colorThisSquare(t,s){let i=t%this.horizontalSquareCount,e=Math.floor(t/this.horizontalSquareCount);const h=8*i,o=Math.min(8*(i+1)-1,this.width),n=8*e,a=Math.min(8*(e+1)-1,this.height),A=s(h,n);this.colorThisPixel(h,n,A);for(let t=h+1;t<o;++t){const i=s(t,n);this.colorThisPixel(t,n,i)}for(let t=n+1;t<a;++t)for(let i=h;i<=o;++i){const e=s(i,t);this.colorThisPixel(i,t,e)}for(let t=h+1;t<o;++t){const i=s(t,a);this.colorThisPixel(t,a,i)}}writePixels(t){if(this.currentQueue==this.queues.length)return!1;if(-1==this.currentQueue){if(this.nextIncrement<2){for(let t=0;t<this.queues.length;++t)console.log(this.queues[t].length);this.currentQueue=0}let s=this.nextIndex<this.root?this.root-1-this.nextIndex:this.nextIndex,i=s%this.horizontalSquareCount,e=Math.floor(s/this.horizontalSquareCount);if(e<this.verticalSquareCount){const h=8*i,o=Math.min(8*(i+1)-1,this.width),n=8*e,a=Math.min(8*(e+1)-1,this.height),A=t(h,n);this.colorThisPixel(h,n,A);const r=t(o,n);this.colorThisPixel(o,n,r);const c=t(h,a);this.colorThisPixel(h,a,c);const l=t(o,a);let g;for(this.colorThisPixel(o,a,l),g=this.queues.length-1;g>=0;--g){const t=this.queueLowerLimits[g];if(A>=t&&r>=t&&c>=t&&l>=t){this.queues[g].push(s);break}}-1==g&&this.colorThisSquare(s,t),this.nextIndex+=this.nextIncrement}else this.levelBegin=this.levelBegin>>1,this.nextIndex=this.levelBegin,this.nextIncrement=this.nextIncrement>>1}else{const s=this.queues[this.currentQueue];this.squareQueueIndex>=s.length?(this.squareQueueIndex=0,++this.currentQueue):(this.colorThisSquare(s[this.squareQueueIndex],t),++this.squareQueueIndex)}return!0}}(this.context,e,(t=>this.codeToColor(t))),this.leftX=-2.5,this.zoomE=8,this.topY=-this.zoomH/2,this.changed=!0,this.osc=document.createElement("canvas"),this.startDragX=h,this.startDragY=h,this.ct=new class{constructor(t,s){if(0===s)throw new Error("k can't be zero");this._b=t,this.k=s,this.calculate()}calculate(){this.a=1/this._b,this.bma=this._b-this.a,this.kDivBmA=this.k/this.bma,console.log("calculate results:"),console.log(this)}unscaled(t){return-1/(t+this.a)+this._b}f(t){return Number.isFinite(this.kDivBmA)?this.unscaled(t/this.kDivBmA)*this.kDivBmA:t}get b(){return this._b}set b(t){this._b=t,this.calculate()}}(5,e),this.wa=new class{constructor(t,s,i,e){this.working=!1,WebAssembly&&WebAssembly.Instance&&WebAssembly.Module&&(this.instance=new WebAssembly.Instance(new WebAssembly.Module(new Uint8Array(function(t){const s=window.atob("AGFzbQEAAAABHwZgAAF/YAAAYAJ8fABgBX9/fHx8AX9gAX8AYAF/AX8DCQgBAAIDAAQFAAQFAXABAQEFBgEBgAKAAgYJAX8BQaCRygYLB5ABCgZtZW1vcnkCABFfX3dhc21fY2FsbF9jdG9ycwAABXBvaW50AAEJaW5pdFRyYW5zAAIEZHJhdwADGV9faW5kaXJlY3RfZnVuY3Rpb25fdGFibGUBABBfX2Vycm5vX2xvY2F0aW9uAAcJc3RhY2tTYXZlAAQMc3RhY2tSZXN0b3JlAAUKc3RhY2tBbGxvYwAGCooFCAMAAQsFAEGACAtdAQJ8IABEAAAAAAAAAABiBEBBgJGKBCAAOQMAQYiRigREAAAAAAAA8D8gAKMiAjkDAERUYBnUX4grSSEDQZCRigQgASAAIAKhoyADIABEAAAAAAAA8D9iGzkDAAsL+gMCB38LfCABQQFOBEAgAiAAt6MhDkGAkYoEKwMAIRNBiJGKBCsDACEUQZCRigQrAwAhDANAQQAhCiAAQQBKBEAgDiAIt6IgBKAhFQNAIA4gCreiIAOgIRZEAAAAAAAAAAAhDUEAIQZEAAAAAAAAAAAhD0QAAAAAAAAAACEQRAAAAAAAAAAAIQIDQAJAIAZBAWohBSAWIBAgD6GgIhEgEaIiECAVIA0gDaAgAqKgIgIgAqIiD6AiEkQAAAAAAAAQQGVFDQAgBkH/A0khByARIQ0gBSEGIAcNAQsLAn9EAAAAAAAA8D9EAAAAAAAA8D8gEkQAAAAAAAAQwKCjIBJEAAAAAAAAFEBjGyAFt6AiAkQAAAAAAACAQGNFBEBBACEGQQAhB0EAIQtBAAwBCwJ/An8gDERUYBnUX4grSWIEQCAMIBNEAAAAAAAA8L8gAiAMoyAUoKOgoiECCyACmUQAAAAAAADgQWMLBEAgAqoMAQtBgICAgHgLIgVBgAJOBEBBgICAeCELIAVBEHRBgICACGshB0EAIQZB/wMgBWsMAQtB/wEgBWshBkGAgIB4IQtBACEHIAULIQUgCUECdEGACGogBUEIdCAGciAHciALcjYCACAJQQFqIQkgCkEBaiIKIABHDQALCyAIQQFqIgggAUcNAAsLQYAIKAIACwQAIwALBgAgACQACxAAIwAgAGtBcHEiACQAIAALBwBBmJGKBAs="),i=new Uint8Array(s.length);for(let t=0;t<s.length;++t)i[t]=s.charCodeAt(t);return i.buffer}()))),this.working=!!(this.instance&&this.instance.exports&&this.instance.exports.initTrans&&this.instance.exports.draw&&this.instance.exports.point)),console.log("WebAssembly working:",this.working),console.log("wa instance:"),console.log(this.instance),this.working&&(this.exports=this.instance.exports,this.updateB(i,e),this.resize(t,s))}updateB(t,s){this.exports.initTrans(t,s)}resize(t,s){if(this.working){const i=this.exports.point();console.log("pointer",i),this.data=new Uint8ClampedArray(this.exports.memory.buffer,i,t*s*4),this.img=new ImageData(this.data,t,s)}}draw(t,s,i,e,h,o){this.exports.draw(s,i,e,h,o),t.putImageData(this.img,0,0)}logPixels(t){const s=[];for(let i=0;i<4*t;++i)s.push(this.data[i]);console.log(s)}}(t,s,5,512),this.useWasm=!1,this.canvas.addEventListener("wheel",(t=>{const s=t.deltaY>0,e=t.offsetX,h=t.offsetY,o=e/this.canvas.width,n=h/this.canvas.height,a=this.leftX+o*this.zoomW,A=this.topY+n*this.zoomH;let r,c,l,g;console.log("mandelbrotX",a,"mandelbrotY",A),s?(this.zoomE=Math.min(16,this.zoomE+1),console.log("zoom out",this.zoomE),r=this.canvas.width/i,c=this.canvas.height/i,l=e-e/i,g=h-h/i):(this.zoomE=Math.max(-256,this.zoomE-1),console.log("zoom in ",this.zoomE),r=this.canvas.width*i,c=this.canvas.height*i,l=e+.5-(e+.5)*i,g=h+.5-(h+.5)*i),this.leftX=Math.min(Math.max(a-o*this.zoomW,-3-Math.pow(2,4)),3),this.topY=Math.min(Math.max(A-n*this.zoomH,-3-Math.pow(2,4)),3),this.osc.width=this.canvas.width,this.osc.height=this.canvas.height;const d=this.osc.getContext("2d");null==d||d.drawImage(this.canvas,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.osc,l,g,r,c),s&&this.fastEdges(l,g,i),this.changed=!0})),this.canvas.addEventListener("mousedown",(t=>{this.startDragX=t.offsetX,this.startDragY=t.offsetY,this.osc.width=this.canvas.width,this.osc.height=this.canvas.height;const s=this.osc.getContext("2d");null==s||s.drawImage(this.canvas,0,0)})),this.canvas.addEventListener("mousemove",(t=>{if(this.startDragY!=h){const s=t.offsetX,i=t.offsetY,e=s-this.startDragX,h=i-this.startDragY;this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.osc,e,h,this.canvas.width,this.canvas.height),this.fastEdges(e,h,1)}})),this.canvas.addEventListener("mouseup",(t=>{this.startDragY!=h&&this.stopDrag(t.offsetX,t.offsetY)})),this.canvas.addEventListener("mouseleave",(t=>{this.startDragY!=h&&this.stopDrag(t.offsetX,t.offsetY)})),console.log("should be 0",this.ct.f(0)),console.log("should be 511",this.ct.f(511)),console.log("should be ~43",this.ct.f(3)),console.log("should be ~100",this.ct.f(11)),console.log("should be ~150",this.ct.f(17)),requestAnimationFrame((()=>{this.draw()}))}get zoomW(){return Math.pow(2,this.zoomE/4)}get zoomH(){return this.zoomW*this.canvas.height/this.canvas.width}stopDrag(t,s){const i=this.startDragX/this.canvas.width,e=this.startDragY/this.canvas.height,o=this.leftX+i*this.zoomW,n=this.topY+e*this.zoomH,a=t/this.canvas.width,A=s/this.canvas.height;this.leftX=o-a*this.zoomW,this.topY=n-A*this.zoomH,t==this.startDragX&&s==this.startDragY||(console.log(`drag change ${t-this.startDragX} ${s-this.startDragY}`),this.changed=!0),this.startDragX=h,this.startDragY=h}fastEdges(t,s,i){t=Math.ceil(t),s=Math.ceil(s);const e=i-1,h=e*this.canvas.width,o=Math.ceil(h-t),n=e*this.canvas.height,a=Math.ceil(n-s),A=1==i?-t:0,r=1==i?-s:0;let c,l=0;const g=16;for(c=0;c<this.canvas.width;c+=g)for(l=0;l<s;l+=g){const[t,s,i]=this.colorForPixel(c+8+A,l+8+r);this.context.fillStyle=`rgb(${t}, ${s}, ${i})`,this.context.fillRect(c,l,g,g)}for(l=s;l<this.canvas.height;l+=g){for(c=0;c<t;c+=g){const[t,s,i]=this.colorForPixel(c+8+A,l+8+r);this.context.fillStyle=`rgb(${t}, ${s}, ${i})`,this.context.fillRect(c,l,g,g)}for(c=this.canvas.width-o;c<this.canvas.width;c+=g){const[t,s,i]=this.colorForPixel(c+8+A,l+8+r);this.context.fillStyle=`rgb(${t}, ${s}, ${i})`,this.context.fillRect(c,l,g,g)}}for(c=t;c<this.canvas.width-o;c+=g)for(l=this.canvas.height-a;l<this.canvas.height;l+=g){const[t,s,i]=this.colorForPixel(c+8+A,l+8+r);this.context.fillStyle=`rgb(${t}, ${s}, ${i})`,this.context.fillRect(c,l,g,g)}}resize(t,s){this.canvas.width=t,this.canvas.height=s,this.context=this.canvas.getContext("2d"),this.useWasm&&this.wa.working&&this.wa.resize(t,s),this.changed=!0}draw(){this.useWasm&&this.wa.working?this.changed&&(this.wa.draw(this.context,this.canvas.width,this.canvas.height,this.zoomW,this.leftX,this.topY),this.changed=!1):(this.changed&&(this.pixelOrderer.reset(this.context),this.changed=!1),this.jsDraw()),requestAnimationFrame((()=>{this.draw()}))}codeToColor(t){let s=0,i=0,h=0;return t<e&&((t=Math.floor(this.ct.f(t))%768)>511?(s=t-512,i=0,h=255-s):t>255?(h=t-256,i=255-h,s=0):(s=255-t,i=t,h=0)),[s,i,h]}codeForPixel(t,i){const h=this.zoomW/this.canvas.width;return s(t*h+this.leftX,i*h+this.topY,e)}colorForPixel(t,s){return this.codeToColor(this.codeForPixel(t,s))}jsDraw(){const t=(t,s)=>this.codeForPixel(t,s),s=Date.now()+12;let i=this.pixelOrderer.writePixels(t);for(;i&&Date.now()<s;)i=this.pixelOrderer.writePixels(t);this.startDragY==h&&this.context.putImageData(this.pixelOrderer.rgba,0,0)}}(t,n)},window.addEventListener("resize",(function(){console.log(`browserZoomLevel: ${window.devicePixelRatio}`);const t=window.innerWidth,s=Math.max(window.innerHeight,document.documentElement.clientHeight);null==o||o.resize(t,s)}),!1),window.onorientationchange=function(){const t=document.getElementsByTagName("html")[0],s=document.getElementsByTagName("body")[0];window.innerWidth<window.innerHeight?(t.style.overflowX="hidden",s.style.overflowX="hidden"):(t.style.overflowX="auto",s.style.overflowX="auto")}})();